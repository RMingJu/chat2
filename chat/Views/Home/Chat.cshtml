
@{
    Layout = null;
}

<!DOCTYPE html>

<!-- Vue.js -->
<script src="~/Scripts/vue.js"></script>

<!-- boostrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
<script src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>

<!-- JQuery -->
<script src="~/Scripts/jquery-1.10.2.min.js"></script>

<!-- chat CSS -->
<link href="~/Content/chat.css" rel="stylesheet" />

<!-- SignalR -->
<script src="~/Scripts/jquery.signalR-2.3.0.min.js"></script>
<script src="~/signalr/hubs"></script>

<html>
<head>
    <meta name="viewport" content="width=device-width" />
    <title>聊天對戰</title>
</head>
<body>
    <h2></h2>
    
    <div id="app">
        <input type="text" id="userID" value="mark">
        <template v-for="x in todos">
            <div class="container" v-bind:class="{ darker:x.myMessage}">
                <img v-bind:src=x.img class="avatar" :class="{right: x.myMessage}" alt="Avatar" style="width:100%;">
                <p v-show="!x.myMessage">{{x.userID}} :</p>
                <p>{{x.text}}</p>
                <span :class="{timeRight: !x.myMessage,timeLeft: x.myMessage}">{{x.time}}</span>
            </div>
        </template>
        <br>
        <br>
        <br>
        <br>
        <br>
        <br>
        <nav class="navbar fixed-bottom navbar-dark bg-dark">
            <div class="input-group mb-3">
                <input v-on:keyup.13="quickSendMessage" type="text" id="txtMessage" class="form-control" placeholder="輸入文字..." aria-label="輸入文字..." aria-describedby="basic-addon2">
                <div class="input-group-append">
                    <button v-on:click="sendMessage" id="btnSend" class="btn btn-outline-success" type="button">傳送</button>
                </div>
            </div>
        </nav>
    </div>

    <script>


        /*
        var messageData = [{
            myMessage: false,
            userID: 'mark',
            type: 'user',
            img: '@Href("~/userImg/bandmember.jpg")',
            text: 'Hello. How are you today?',
            time: '11:00'
        }, {
            myMessage: true,
            userID: 'mary',
            type: 'user',
            img: '@Href("~/userImg/avatar_g2.jpg")',
            text: "Hey! I'm fine. Thanks for asking!",
            time: '11:01'
        }, {
            myMessage: false,
            userID: 'mark',
            type: 'user',
            img: '@Href("~/userImg/bandmember.jpg")',
            text: "Sweet! So, what do you wanna do today?",
            time: '11:02'
        }, {
            myMessage: true,
            userID: 'mary',
            type: 'user',
            img: '@Href("~/userImg/avatar_g2.jpg")',
            text: "Nah, I dunno. Play soccer.. or learn more coding perhaps?",
            time: '11:03'
        }];
        */

        var messageData = [];


        //建立hub
        var testHub = $.connection.testHubs;

        //用戶名稱
        var userID = window.prompt("請輸入使用者名稱");

        //建立連線
        $.connection.hub.start().done(function () {
            testHub.server.hello(userID);
        });
        //連線成功顯示歡迎訊息
        testHub.client.hello = function (message) {

            var currentdate = new Date(); 
            var datetime = "Last Sync: " + currentdate.getDate() + "/"
                + (currentdate.getMonth()+1)  + "/" 
                + currentdate.getFullYear() + " @@ "  
                + currentdate.getHours() + ":"  
                + currentdate.getMinutes() + ":" 
                + currentdate.getSeconds();


            let helloMessage = {
                myMessage: false,
                userID: '聊天室小天使',
                type: 'user',
                img: '@Href("~/userImg/admin.jpg")',
                text: message,
                time: datetime
            }
            messageData.push(helloMessage);
            console.log(message);
        };

        //addNewMessageToPage
        testHub.client.addNewMessageToPage = function (name, message) {

                var currentdate = new Date(); 
                var datetime = "時間: " + currentdate.getDate() + "/"
                    + (currentdate.getMonth()+1)  + "/" 
                    + currentdate.getFullYear() + " @@ "  
                    + currentdate.getHours() + ":"  
                    + currentdate.getMinutes() + ":" 
                    + currentdate.getSeconds();

                let isMyMessage = false;
                if (userID == name) isMyMessage = true;
                let helloMessage = {
                    myMessage: isMyMessage,
                    userID: name,
                    type: 'user',
                    img: '@Href("~/userImg/")' + 'admin.jpg',
                    text: message,
                    time: datetime
                }
                messageData.push(helloMessage);
                };

       
        //vue
        myObject = new Vue({
            el: '#app',
            data: {
                todos: messageData
            },
            methods: {
                sendMessage: function () {
                    // console.log(this.todos);
                    //var obj = {
                    //    myMessage: true,
                    //    userID: 'mary',
                    //    type: "user",
                    //    img: '/userImg/avatar_g2.jpg',
                    //    text: "Nah, I dunno. Play soccer.. or learn more coding perhaps?",
                    //    time: '11:04'
                    //};
                    //var txtmessage = $("#txtMessage").val();
                    //console.log('txtmessage :', txtmessage);

                    //if (this.todos == null) {
                    //    this.todos = JSON.parse(obj);
                    //} else {
                    //    this.todos.push(obj);
                    //}
                    //window.scrollTo(0, document.body.scrollHeight);

                    
                    //傳送訊息至Server端
                    testHub.server.send(userID, $('#txtMessage').val());
                    //清空訊息欄位
                    $('#txtMessage').val('');




                },
                quickSendMessage: function () {
                    this.sendMessage();
                }
            }
        })
    </script>

</body>
</html>
